{% extends 'base.html' %}
{% block content %}
<!-- Centered Heading -->
<div class="text-center my-4">
    <h2>AI Translator CHAT BOT</h2>
</div>

<div id="translator-container" class="translator-box">

    <!-- Language Selection & Context -->
    <div class="mb-2">
        <label>Source Language:
            <select id="source-lang" class="form-control d-inline w-auto">
                <option value="auto">Auto Detect</option>
                <option value="sq">Albanian</option>
                <option value="ar">Arabic</option>
                <option value="az">Azerbaijani</option>
                <option value="bn">Bengali</option>
                <option value="be">Belarusian</option>
                <option value="bg">Bulgarian</option>
                <option value="ca">Catalan</option>
                <option value="zh">Chinese</option>
                <option value="hr">Croatian</option>
                <option value="cs">Czech</option>
                <option value="da">Danish</option>
                <option value="nl">Dutch</option>
                <option value="en">English</option>
                <option value="eo">Esperanto</option>
                <option value="et">Estonian</option>
                <option value="fi">Finnish</option>
                <option value="fr">French</option>
                <option value="ka">Georgian</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="ht">Haitian Creole</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="hu">Hungarian</option>
                <option value="is">Icelandic</option>
                <option value="id">Indonesian</option>
                <option value="ga">Irish</option>
                <option value="it">Italian</option>
                <option value="ja">Japanese</option>
                <option value="kab">Kabyle</option>
                <option value="ko">Korean</option>
                <option value="ku">Kurdish</option>
                <option value="lv">Latvian</option>
                <option value="lt">Lithuanian</option>
                <option value="mk">Macedonian</option>
                <option value="ms">Malay</option>
                <option value="ml">Malayalam</option>
                <option value="mt">Maltese</option>
                <option value="mn">Mongolian</option>
                <option value="ne">Nepali</option>
                <option value="no">Norwegian</option>
                <option value="pa">Punjabi</option>
                <option value="fa">Persian</option>
                <option value="pl">Polish</option>
                <option value="pt">Portuguese</option>
                <option value="ro">Romanian</option>
                <option value="ru">Russian</option>
                <option value="sr">Serbian</option>
                <option value="sk">Slovak</option>
                <option value="sl">Slovenian</option>
                <option value="es">Spanish</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="ta">Tamil</option>
                <option value="te">Telugu</option>
                <option value="th">Thai</option>
                <option value="tr">Turkish</option>
                <option value="uk">Ukrainian</option>
                <option value="ur">Urdu</option>
                <option value="uz">Uzbek</option>
                <option value="vi">Vietnamese</option>
            </select>
        </label>
        <label>Target Language:
            <select id="target-lang" class="form-control d-inline w-auto">
                <option value="sq">Albanian</option>
                <option value="ar">Arabic</option>
                <option value="az">Azerbaijani</option>
                <option value="bn">Bengali</option>
                <option value="be">Belarusian</option>
                <option value="bg">Bulgarian</option>
                <option value="ca">Catalan</option>
                <option value="zh">Chinese</option>
                <option value="hr">Croatian</option>
                <option value="cs">Czech</option>
                <option value="da">Danish</option>
                <option value="nl">Dutch</option>
                <option value="en">English</option>
                <option value="eo">Esperanto</option>
                <option value="et">Estonian</option>
                <option value="fi">Finnish</option>
                <option value="fr">French</option>
                <option value="ka">Georgian</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="ht">Haitian Creole</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="hu">Hungarian</option>
                <option value="is">Icelandic</option>
                <option value="id">Indonesian</option>
                <option value="ga">Irish</option>
                <option value="it">Italian</option>
                <option value="ja">Japanese</option>
                <option value="kab">Kabyle</option>
                <option value="ko">Korean</option>
                <option value="ku">Kurdish</option>
                <option value="lv">Latvian</option>
                <option value="lt">Lithuanian</option>
                <option value="mk">Macedonian</option>
                <option value="ms">Malay</option>
                <option value="ml">Malayalam</option>
                <option value="mt">Maltese</option>
                <option value="mn">Mongolian</option>
                <option value="ne">Nepali</option>
                <option value="no">Norwegian</option>
                <option value="pa">Punjabi</option>
                <option value="fa">Persian</option>
                <option value="pl">Polish</option>
                <option value="pt">Portuguese</option>
                <option value="ro">Romanian</option>
                <option value="ru">Russian</option>
                <option value="sr">Serbian</option>
                <option value="sk">Slovak</option>
                <option value="sl">Slovenian</option>
                <option value="es">Spanish</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="ta">Tamil</option>
                <option value="te">Telugu</option>
                <option value="th">Thai</option>
                <option value="tr">Turkish</option>
                <option value="uk">Ukrainian</option>
                <option value="ur">Urdu</option>
                <option value="uz">Uzbek</option>
                <option value="vi">Vietnamese</option>
            </select>
        </label>
        <select id="context" class="form-select form-select-sm d-inline w-auto">
            <option value="default">Default</option>
            <option value="formal">Formal</option>
            <option value="informal">Informal</option>
        </select>
    </div>

    <!-- WhatsApp-Style Chat Box -->
    <div id="chat-box" class="mb-3 chat-bubble-container"></div>
    <div class="input-group mb-3">
        <input type="text" class="form-control" id="user-input" placeholder="Type or use microphone..." autocomplete="off" onkeydown="if(event.key==='Enter'){sendMessage();}">
        <button class="btn btn-primary smart-btn" onclick="sendMessage()">Send</button>
        <button class="btn btn-secondary smart-btn" onclick="startSpeechRecognition()">üé§</button>
        <select id="voice-select" class="form-select form-select-sm d-inline w-auto ms-2" title="Male voice only works with advanced TTS engines">
            <option value="female" selected>Female Voice</option>
            <option value="male">Male Voice</option>
        </select>
    </div>

    <!-- Fullscreen & Clear Controls, plus new clear history and clear favorites -->
    <div class="d-flex flex-wrap gap-3 mb-3 fullscreen-controls">
        <button id="fullscreen-btn" class="btn btn-outline-secondary btn-sm smart-btn" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>
        <button id="clear-chat-btn" class="btn btn-danger btn-sm smart-btn" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
        <button id="clear-history-btn" class="btn btn-warning btn-sm smart-btn" onclick="clearHistory()">üßπ Clear History</button>
        <button id="clear-favorites-btn" class="btn btn-danger btn-sm smart-btn" onclick="clearFavorites()">‚ùå Clear Favorites</button>
    </div>

    <!-- Audio Player with play/pause -->
    <div id="audio-controls" style="display:none;" class="mb-3">
        <audio id="tts-audio" src="" preload="auto"></audio>
        <button id="play-btn" class="btn btn-success smart-btn btn-sm" onclick="playAudio()">‚ñ∂Ô∏è Play</button>
        <button id="pause-btn" class="btn btn-warning smart-btn btn-sm" onclick="pauseAudio()">‚è∏Ô∏è Pause</button>
    </div>

    <!-- OCR Integration -->
    <div class="mt-4">
        <h5>Upload Image for OCR</h5>
        <form id="ocr-form" enctype="multipart/form-data" onsubmit="event.preventDefault(); uploadImage();">
            <input type="file" id="ocr-image" name="image" accept="image/*" required>
            <button type="submit" class="btn btn-info smart-btn btn-sm">Extract &amp; Translate</button>
        </form>
        <div id="ocr-result" class="mt-2"></div>
    </div>
</div>

<!-- Responsive Favorites Section -->
<div class="mt-4">
    <h5>Your Favorites</h5>
    <div class="table-responsive">
    <ul id="favorite-list" class="list-group list-group-flush flex-wrap flex-row">
        {% for fav in favorites %}
        <li id="fav-{{ fav.id }}" class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
            <span>
                {{ fav.phrase }} ({{ fav.source_lang }}) ‚Äî
                <strong>{{ fav.translation }} ({{ fav.target_lang }})</strong>
            </span>
            <button onclick="removeFavorite({{ fav.id }})" class="btn btn-danger smart-btn btn-sm ms-2">Remove</button>
        </li>
        {% else %}
        <li class="list-group-item">No favorites yet.</li>
        {% endfor %}
    </ul>
    </div>
</div>

<!-- Chat History Section -->
<div class="mt-4">
    <h5>Chat History</h5>
    <div class="table-responsive">
    <ul id="history-list" class="list-group list-group-flush flex-wrap flex-row">
        {% for h in history %}
        <li id="hist-{{ h.id }}" class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
            <span>
                {{ h.message }} ({{ h.source_lang }}) ‚Üí
                <strong>{{ h.translated }} ({{ h.target_lang }})</strong>
                <span>on {{ h.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
                {% if h.rating %}
                    ‚Äî Rated: {{ h.rating }}/5
                    {% if h.feedback %} ({{ h.feedback }}){% endif %}
                {% else %}
                    <button onclick="showRating({{ h.id }})" class="btn btn-outline-primary smart-btn btn-sm ms-2">Rate</button>
                    <div id="rating-box-{{ h.id }}" class="rating-box" style="display:none; margin-top:8px;">
                        <input type="number" id="rating-value-{{ h.id }}" min="1" max="5" class="form-control d-inline w-auto" placeholder="1-5">
                        <input type="text" id="rating-feedback-{{ h.id }}" placeholder="Feedback" class="form-control d-inline w-auto">
                        <button onclick="submitRating({{ h.id }})" class="btn btn-success smart-btn btn-sm">Submit</button>
                        <button onclick="hideRating({{ h.id }})" class="btn btn-secondary smart-btn btn-sm">Cancel</button>
                    </div>
                {% endif %}
            </span>
            <button onclick="addFavoriteFromHistory('{{ h.message|e }}','{{ h.translated|e }}','{{ h.source_lang|e }}','{{ h.target_lang|e }}')" class="btn btn-info smart-btn btn-sm ms-2">Add to Favorites</button>
        </li>
        {% else %}
        <li class="list-group-item">No chat history yet.</li>
        {% endfor %}
    </ul>
    </div>
</div>

<link rel="stylesheet" href="/static/smart-buttons.css">
<link rel="stylesheet" href="/static/whatsapp-chat.css">
<script src="/static/main.js"></script>
{% endblock %}